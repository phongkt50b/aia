<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Công Cụ Tính Phí Bảo Hiểm AIA</title>
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<link href="style.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet"/>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
<header class="flex items-center justify-between pb-6 border-b-2 border-red-600 mb-6">
  <img src="https://www.aia.com.vn/content/dam/group-wise/images/system/icons/aia-logo-red.svg" alt="AIA Logo" class="h-8" />
  <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-right">Công Cụ Minh Họa Phí Bảo Hiểm</h1>
</header>

<main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <div class="lg:col-span-2 space-y-6">

    <!-- Section 1: NĐBH chính -->
    <div id="main-person-container" class="person-container space-y-6 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-xl font-bold text-aia-red mb-4">1. Thông Tin Người Được Bảo Hiểm Chính</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-medium block mb-1">Họ và Tên</label>
          <input type="text" class="form-input name-input" placeholder="Nguyễn Văn A">
        </div>
        <div>
          <label class="font-medium block mb-1">Ngày sinh</label>
          <input type="text" class="form-input dob-input" placeholder="DD/MM/YYYY">
        </div>
        <div>
          <label class="font-medium block mb-1">Giới tính</label>
          <select class="form-select gender-select">
            <option value="Nam">Nam</option>
            <option value="Nữ">Nữ</option>
          </select>
        </div>
        <div class="flex items-end">
          <p class="text-lg">Tuổi: <span class="font-bold text-aia-red age-span">0</span></p>
        </div>
        <div class="relative">
          <label class="font-medium block mb-1">Nghề nghiệp</label>
          <input type="text" class="form-input occupation-input" placeholder="Gõ để tìm nghề nghiệp...">
          <div class="occupation-autocomplete hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto"></div>
        </div>
        <div class="flex items-end">
          <p class="text-lg">Nhóm nghề: <span class="font-bold text-aia-red risk-group-span">...</span></p>
        </div>
      </div>
    </div>

    <!-- Section 2: Sản phẩm chính -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-xl font-bold text-aia-red mb-4">2. Lựa Chọn Sản Phẩm Chính</h2>
      <div>
        <select id="main-product" class="form-select">
          <option value="">-- Chọn sản phẩm chính --</option>
          <option value="PUL_TRON_DOI">PUL Trọn đời</option>
          <option value="PUL_15_NAM">PUL 15 năm</option>
          <option value="PUL_5_NAM">PUL 5 năm</option>
          <option value="KHOE_BINH_AN">MUL - Khoẻ Bình An</option>
          <option value="VUNG_TUONG_LAI">MUL - Vững Tương Lai</option>
          <option value="TRON_TAM_AN">Trọn tâm an</option>
          <option value="AN_BINH_UU_VIET">An Bình Ưu Việt</option>
        </select>
      </div>
      <div id="main-product-options" class="mt-4 space-y-4"></div>
      <div id="main-product-fee-display" class="text-right font-bold text-lg text-aia-red mt-2 min-h-[1.75rem]"></div>
    </div>

    <!-- Section 3: SP bổ sung cho NĐBH chính -->
    <div id="main-supp-container" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-xl font-bold text-aia-red mb-4">3. Lựa Chọn Sản Phẩm Bổ Sung (Cho NĐBH Chính)</h2>
      <div class="supplementary-products-container space-y-6">
        <!-- JS sẽ render -->
      </div>
    </div>

    <!-- Section 4: NĐBH bổ sung -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h2 class="text-xl font-bold text-aia-red mb-4">4. Người Được Bảo Hiểm Bổ Sung</h2>
      <div id="supplementary-insured-container" class="space-y-6"></div>
      <button id="add-supp-insured-btn" class="mt-4 px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors w-full text-left flex items-center space-x-2">
        <span>+ Thêm Người Được Bảo Hiểm Bổ Sung</span>
      </button>
    </div>

    <!-- Section 5: Miễn Đóng Phí 3.0 -->
    <div id="mdp3-section" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hidden">
      <h2 class="text-xl font-bold text-aia-red mb-4">5. Miễn Đóng Phí 3.0 (Bên mua bảo hiểm)</h2>
      <div class="flex items-center space-x-2 mb-3">
        <input type="checkbox" id="mdp3-enable" class="form-checkbox">
        <label for="mdp3-enable" class="text-gray-700 font-medium">
          Miễn đóng phí 3.0
        </label>
      </div>
      <div id="mdp3-radio-list">
        <div id="mdp3-select-container"></div>
      </div>
      <div id="mdp3-fee-display" class="mt-3 text-aia-red font-bold"></div>
    </div>
  </div>

  <!-- Cột kết quả: Compact Card -->
  <div class="lg:col-span-1">
    <div id="results-container" class="bg-white p-5 rounded-xl shadow-sm border-2 border-aia-red sticky top-8 space-y-3">

      <!-- Tổng năm -->
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold text-gray-700">Tổng phí (năm)</h2>
      </div>
      <div class="text-3xl font-extrabold text-aia-red tracking-tight">
        <span id="summary-total">0</span>
      </div>

      <!-- Nhóm chính -->
      <div class="border-t pt-3">
        <ul class="text-sm space-y-1">
          <li class="flex justify-between">
            <span>Phí sản phẩm chính</span><span id="main-insured-main-fee">0</span>
          </li>
          <li class="flex justify-between">
            <span>Phí đóng thêm</span><span id="main-insured-extra-fee">0</span>
          </li>
          <li class="flex justify-between">
            <span>Phí sản phẩm bổ sung</span><span id="summary-supp-fee">0</span>
          </li>
        </ul>
      </div>

      <!-- Nhóm bổ sung: danh sách từng người -->
      <div class="border-t pt-3">
        <div id="supp-insured-summary-line" class="flex justify-between text-sm mt-1">
          <button id="toggle-supp-list-btn" class="text-xs text-aia-red underline">Xem từng người</button>
        </div>
        <div id="supp-insured-summaries" class="mt-2 hidden text-sm space-y-1"></div>
      </div>
    
      <!-- Kỳ đóng phí (tự ẩn/hiện theo ngưỡng 7tr/8tr) -->
      <div>
        <label for="payment-frequency" class="font-medium text-gray-700 block mb-1">Kỳ đóng phí</label>
        <select id="payment-frequency" class="form-select w-full" aria-label="Kỳ đóng phí">
          <option value="year" selected>Năm (mặc định)</option>
          <option value="half">Nửa năm</option>
          <option value="quarter">Quý</option>
        </select>
      </div>

      <!-- Breakdown theo kỳ -->
      <div id="frequency-breakdown" class="space-y-1 text-sm text-gray-700 hidden">
        <div>Phí chính + đóng thêm (theo kỳ): <span id="freq-main-plus-extra">0</span></div>
        <div>Phí sản phẩm bổ sung (theo kỳ): <span id="freq-supp-total">0</span></div>
        <div class="font-semibold">Tổng (theo kỳ): <span id="freq-total-period" class="text-aia-red">0</span></div>
        <div class="text-sm">Quy năm: <span id="freq-total-year">0</span></div>
        <div class="text-sm">Chênh lệch so với đóng 1 năm: <span id="freq-diff">0</span></div>
      </div>

      <!-- Minh họa đến năm -->
      <div class="border-t pt-3 space-y-2">
        <div>
          <label for="target-age-input" class="font-medium text-gray-700 block mb-1">Minh họa phí đến năm (tuổi NĐBH chính)</label>
          <input type="number" id="target-age-input" class="form-input" placeholder="VD: 75" min="0" max="100">
        </div>
        <button id="view-summary-btn" class="w-full bg-aia-red text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors" aria-controls="summary-modal">Xem Bảng Minh Họa Chi Tiết</button>
        <div id="error-message" class="text-center text-red-500 font-medium min-h-[1.25rem]" aria-live="assertive"></div>
      </div>

      <!-- Shim cho các ID cũ -->
      <div id="compat-shim" class="hidden">
        <span id="main-premium-result">0</span>
        <div id="supplementary-premiums-results"></div>
        <span id="total-premium-result">0</span>
      </div>

    </div>
  </div>
</main>

<footer class="text-center text-gray-500 mt-12 py-4 border-t">
  Công cụ này chỉ mang tính chất tham khảo cá nhân, không phải là bảng minh họa chính thức của AIA. Quyền lợi và mức phí cụ thể sẽ được xác nhận trong hợp đồng do AIA phát hành. 
  Vui lòng liên hệ tư vấn viên AIA để được tư vấn chi tiết và nhận bảng minh họa chính thức
</footer>
</div>

<!-- Modal -->
<div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="summary-modal-title">
  <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col">
    <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
      <h2 id="summary-modal-title" class="text-2xl font-bold text-aia-red">Bảng Tóm Tắt Quyền Lợi và Phí</h2>
      <button id="close-summary-modal-btn" class="text-3xl font-light leading-none hover:text-red-600" aria-label="Đóng bảng tóm tắt">&times;</button>
    </div>
    <div id="summary-content-container" class="p-6 overflow-y-auto"></div>
    <div class="p-6 border-t">
      <p class="font-bold text-gray-800">
        Công cụ này chỉ mang tính chất tham khảo cá nhân, không phải là bảng minh họa chính thức của AIA.
        Quyền lợi và mức phí cụ thể sẽ được xác nhận trong hợp đồng do AIA phát hành.
        Vui lòng liên hệ tư vấn viên AIA để được tư vấn chi tiết và nhận bảng minh họa chính thức.
      </p>
    </div>
  </div>
</div>

<!-- Scripts -->
<script type="module" src="logic.js"></script>
<script type="module" src="data.js"></script>
<script>
/* --- HOTFIX INLINE (chạy chắc chắn) --- */
(function(){
  // Badge xác nhận đã load
  (function okBadge(){
    const b = document.createElement('div');
    b.textContent = 'HOTFIX ✓';
    Object.assign(b.style,{position:'fixed',right:'8px',bottom:'8px',padding:'2px 6px',background:'#16a34a',color:'#fff',fontSize:'12px',borderRadius:'6px',zIndex:99999,opacity:.8});
    document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(b));
    setTimeout(()=>b.remove(), 4000);
  })();

  const q  = (s,r=document)=>r.querySelector(s);
  const qa = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const int = t => {const v=parseInt(String(t||'').replace(/[^\d\-]/g,''),10);return isNaN(v)?0:v};
  const cur = n => (Number(n)||0).toLocaleString('vi-VN');
  const san = s => String(s??'');

  /* 1) Nút "Xem từng người" giữ nguyên nhãn, không đổi khi đổi kỳ */
  function lockToggleBtn(){
    const btn=q('#toggle-supp-list-btn'), list=q('#supp-insured-summaries');
    if(!btn||!list) return;
    const LABEL='Xem từng người';
    const clone = btn.cloneNode(true);
    btn.replaceWith(clone);
    clone.textContent = LABEL;
    clone.addEventListener('click', e=>{ e.preventDefault(); list.classList.toggle('hidden'); clone.textContent=LABEL; }, true);
    new MutationObserver(()=>{ if((clone.textContent||'').trim()!==LABEL) clone.textContent=LABEL; })
      .observe(clone,{childList:true,characterData:true,subtree:true});
  }

  /* 2) Danh sách từng người: thêm dòng NĐBH chính + cộng Miễn đóng phí 3.0 đúng người */
  function getMdp3(){
    try{
      if(!q('#mdp3-enable')?.checked) return {id:null,fee:0};
      const api=window.MDP3||{};
      return { id: api.getSelectedId?api.getSelectedId():null, fee: Number(api.getPremium?api.getPremium():0)||0 };
    }catch(_){ return {id:null,fee:0}; }
  }
  function adjustSuppList(){
    const wrap=q('#supp-insured-summaries'); if(!wrap) return;
    const mainName = q('#main-person-container .name-input')?.value?.trim() || 'NĐBH chính';
    let hasMainRow = qa(':scope > *',wrap).some(el => (el.textContent||'').includes(mainName));
    if(!hasMainRow){
      const dv=document.createElement('div');
      dv.className='flex justify-between items-center py-1 text-sm';
      dv.innerHTML=`<span>${san(mainName)}</span><span class="font-semibold">0</span>`;
      wrap.prepend(dv);
    }
    const {id:mdpId,fee:mdpFee}=getMdp3();
    if(mdpFee>0){
      let targetName=null;
      if(mdpId==='main-person-container') targetName=mainName;
      else if(mdpId && mdpId!=='other'){
        const c=document.getElementById(mdpId);
        targetName=c?.querySelector('.name-input')?.value?.trim()||null;
      }
      if(targetName){
        const row=qa(':scope > *',wrap).find(el => (el.textContent||'').includes(targetName));
        if(row){
          const val=row.querySelector('span:last-child');
          const curVal=int(val?.textContent);
          val.textContent=cur(curVal+mdpFee);
        }
      }
      // "other" => không thêm dòng riêng
    }
  }
  // bọc render gốc (nếu có), luôn hậu xử lý
  (function wrapSuppList(){
    const orig = window.renderSuppListSimple || window.renderSuppListSimplePatched;
    window.renderSuppListSimple = function(){
      if(typeof orig==='function') try{ orig.apply(this,arguments); }catch(_){}
      try{ adjustSuppList(); }catch(_){}
    };
  })();

  /* 3) Khối kỳ đóng phí: xoá dòng "Kỳ: ...", ẩn dòng = 0, ẩn "Chênh lệch" khi kỳ = Năm */
  function cleanupFrequencyPanel(){
    const pane=q('#frequency-breakdown'), sel=q('#payment-frequency');
    if(!pane||!sel) return;
    // xoá dòng "Kỳ: ..."
    const first=pane.querySelector(':scope > div');
    if(first && /^\s*Kỳ\s*:/.test(first.textContent||'')) first.remove();

    const isYear = sel.value==='year';
    const ids=['freq-main-plus-extra','freq-supp-total','freq-total-period','freq-total-year','freq-diff'];
    ids.forEach(id=>{
      const el=q('#'+id); if(!el) return;
      el.textContent=(el.textContent||'').replace(/\s*VNĐ\s*$/i,''); // bỏ VNĐ dư
      const row=el.closest('div'); if(!row) return;
      const v=int(el.textContent);
      const hide=(v===0)|| (id==='freq-diff' && isYear);
      row.classList.toggle('hidden',hide);
    });
    pane.classList.toggle('hidden', isYear);
  }

  /* 4) Báo cáo chi tiết: đổi nhãn "Số năm đóng phí"; điền STBH cho Miễn đóng phí 3.0; ẩn ô = 0; ẩn cột chênh lệch khi Năm */
  function computeMdp3StbhBase(){
    const pf=window.personFees||{};
    let stbh=0;
    if(Object.keys(pf).length){
      for(const k in pf) stbh += (pf[k].mainBase||0) + (pf[k].supp||0);
    }else{
      qa('#supp-insured-summaries span:last-child').forEach(el=> stbh+=int(el.textContent));
    }
    return stbh;
  }
  function postprocessSummary(){
    const box=q('#summary-content-container'); if(!box) return;
    // đổi nhãn
    box.querySelectorAll('th').forEach(th=>{
      if(/Năm\s+đóng\s+phí/i.test(th.textContent||'')) th.textContent='Số năm đóng phí';
    });
    // điền STBH cho "Miễn đóng phí 3.0"
    const stbh=computeMdp3StbhBase();
    box.querySelectorAll('table tbody tr').forEach(tr=>{
      const tds=tr.querySelectorAll('td');
      if(tds.length>=5 && /Miễn đóng phí\s*3\.0/i.test(tds[1]?.textContent||'')){
        const c=tds[2], txt=(c.textContent||'').trim();
        if(txt==='—'||txt==='-') c.textContent=cur(stbh);
      }
    });
    // ẩn ô = 0
    box.querySelectorAll('td').forEach(td=>{ if(int(td.textContent)===0) td.textContent=''; });
    // ẩn cột chênh lệch nếu kỳ = Năm
    const sel=q('#payment-frequency'); const isYear=(sel?.value==='year');
    if(isYear){
      const ths=Array.from(box.querySelectorAll('thead th'));
      const idx=ths.findIndex(th=>/Chênh lệch/i.test(th.textContent||''));
      if(idx>=0){
        ths[idx].style.display='none';
        box.querySelectorAll('tbody tr').forEach(tr=>{ const c=tr.children[idx]; if(c) c.style.display='none'; });
      }
    }
  }
  (function wrapSummary(){
    const orig=window.generateSummaryTable;
    window.generateSummaryTable=function(){
      if(typeof orig==='function') orig.apply(this,arguments);
      try{ postprocessSummary(); }catch(_){}
    };
  })();

  /* 5) Gắn vòng đời */
  function start(){
    try{ lockToggleBtn(); }catch(_){}
    try{ cleanupFrequencyPanel(); }catch(_){}
    try{ adjustSuppList(); }catch(_){}
    // Sau mỗi lần UI update từ code cũ
    const prev=window.updateSummaryUI;
    window.updateSummaryUI=function(){
      const r = typeof prev==='function' ? prev.apply(this,arguments) : undefined;
      try{ cleanupFrequencyPanel(); }catch(_){}
      try{ adjustSuppList(); }catch(_){}
      return r;
    };
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',start); } else { start(); }
})();
</script>

</body>
</html>
